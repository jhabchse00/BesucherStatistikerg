<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard â€” BÃ¼chsenstadel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{--bg:#f5f7fb;--card:#fff;--muted:#7b8594;--accent:#3b82f6}
  body{font-family:Inter,system-ui; margin:0; background:var(--bg); color:#222}

  /* Centered password screen */
  #authScreen {
    position:fixed; inset:0; background:var(--bg);
    display:flex; justify-content:center; align-items:center;
    flex-direction:column; gap:12px;
    font-size:16px;
  }
  #authScreen input {
    padding:10px 14px; border-radius:8px;
    border:1px solid #d0d5dd; font-size:16px;
  }
  #authScreen button {
    padding:10px 20px; cursor:pointer;
    border:none; border-radius:8px;
    background:var(--accent); color:white;
    font-size:16px;
  }

  .wrap{max-width:1100px;margin:28px auto;padding:18px; display:none;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:right}

  table { width:100%; border-collapse:collapse; margin-top:14px; }
  th, td { padding:8px 12px; border-bottom:1px solid #e5e7eb; font-size:14px; }
  th { background:#f0f2f6; text-align:left; }

</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<!-- ============================
     ðŸ”’ AUTHENTICATION SCREEN
============================= -->
<div id="authScreen">
  <h2>Admin Login</h2>
  <input id="pwInput" type="password" placeholder="Passwort eingebenâ€¦" />
  <button onclick="checkPassword()">Login</button>
  <div id="pwError" style="color:red;display:none;">Falsches Passwort</div>
</div>

<!-- ============================
     MAIN DASHBOARD
============================= -->
<div class="wrap" id="dashboard">

  <header>
    <h1>BÃ¼chsenstadel â€” Admin Dashboard</h1>
    <div id="lastUpdate" style="color:var(--muted);font-size:13px">loadingâ€¦</div>
  </header>

  <!-- ======= COMBINATION SUMMARY ======= -->
  <div class="card">
    <h3>Kombinationen (Alter Ã— Geschlecht Ã— Migration) â€” letzte 7 Tage</h3>
    <table id="comboTable">
      <thead>
        <tr>
          <th>Alter</th>
          <th>Geschlecht</th>
          <th>Migrationshintergrund</th>
          <th>Anzahl</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ======= RAW ROWS TABLE ======= -->
  <div class="card" style="margin-top:20px;">
    <h3>Alle EintrÃ¤ge (wie Google Sheet) â€” letzte 7 Tage</h3>
    <table id="rawTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Alter</th>
          <th>Migrationshintergrund</th>
          <th>Geschlecht</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>Datenquelle: Google Sheets</footer>
</div>

<script>
/* ============================
   ðŸ”’ Password check
============================= */
const PASSWORD = "89073";

function checkPassword() {
  const inp = document.getElementById("pwInput").value.trim();
  if (inp === PASSWORD) {
    document.getElementById("authScreen").style.display="none";
    document.getElementById("dashboard").style.display="block";
  } else {
    document.getElementById("pwError").style.display="block";
  }
}

/* ============================
   ðŸ“Š CSV CONFIG
============================= */

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaFKAQwcvl7c7dT1HI_aj7THVW9DKYLGXPtvn_WR7uYEAzxyUjH3DVmTFxZefhWF5FcXoHnK-XJim5/pub?gid=1664273841&single=true&output=csv";  /* keep your actual link */

/* Simple CSV parser */
function parseCSV(t){
  return t.split(/\r?\n/).map(r => r.split(","));
}

/* ============================
   MAIN FETCH + LOGIC
============================= */
async function loadData(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);

    const header = rows[0];
    const body = rows.slice(1).filter(r => r.join("").trim() !== "");

    // Collect indexes
    const idxTS = header.indexOf("Timestamp");
    const idxAge = header.indexOf("Alter");
    const idxMig = header.indexOf("Migrationshintergrund");
    const idxGen = header.indexOf("Geschlecht");

    if ([idxTS,idxAge,idxMig,idxGen].includes(-1)) {
      alert("Header problem!");
      return;
    }

    const now = Date.now();
    const last7 = 7 * 24 * 60 * 60 * 1000;

    const filtered = body.filter(r=>{
      const ts = new Date(r[idxTS]).getTime();
      return now - ts < last7;
    });

    /* ========= Fill raw table ========= */
    const rawTbody = document.getElementById("rawTable").querySelector("tbody");
    rawTbody.innerHTML = "";
    filtered.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r[idxTS]}</td>
        <td>${r[idxAge]}</td>
        <td>${r[idxMig]}</td>
        <td>${r[idxGen]}</td>
      `;
      rawTbody.appendChild(tr);
    });

    /* ========= Build combination summary ========= */
    const combos = {}; // { "age | gender | mig": count }

    filtered.forEach(r=>{
      const key = `${r[idxAge]}|${r[idxGen]}|${r[idxMig]}`;
      combos[key] = (combos[key]||0) + 1;
    });

    const comboTbody = document.getElementById("comboTable").querySelector("tbody");
    comboTbody.innerHTML = "";

    Object.entries(combos).forEach(([k,v])=>{
      const [a,g,m] = k.split("|");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a}</td>
        <td>${g}</td>
        <td>${m}</td>
        <td>${v}</td>
      `;
      comboTbody.appendChild(tr);
    });

    document.getElementById("lastUpdate").textContent =
      "Letzte Aktualisierung: " + new Date().toLocaleString();

  } catch(e){
    alert("Fehler beim Laden der Daten");
    console.error(e);
  }
}

loadData();
</script>
</body>
</html>
