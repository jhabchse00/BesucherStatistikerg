<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Büchsenstadel (Raw + Kombinationen)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{--bg:#f5f7fb;--card:#fff;--muted:#6b7280;--accent:#2563eb}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
  .full{grid-column:1 / -1}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text]{padding:8px;border-radius:8px;border:1px solid #e6edf8;font-size:14px}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent);border:1px solid #dfeeff}
  .small{font-size:13px;color:var(--muted)}
  .table-wrap{max-height:420px;overflow:auto;margin-top:10px;border-radius:8px;border:1px solid #eef5fb}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px 10px;border-bottom:1px solid #f1f6fb;text-align:left}
  th{background:#fbfdff;position:sticky;top:0}
  .comb-list td:nth-child(4){font-weight:700;text-align:right}
  @media (max-width:900px){.grid{grid-template-columns:1fr}.table-wrap{max-height:320px}}
</style>
</head>

<body>
<div class="wrap">

  <header>
    <div>
      <h1>Büchsenstadel — Admin</h1>
      <div class="small">Rohdaten + Kombinationen · Live aus Google Sheets</div>
    </div>
    <div class="controls">
      <button id="refreshBtn">Neu laden</button>
      <button id="downloadBtn" class="ghost">Export CSV</button>
    </div>
  </header>

  <!-- FILTER SECTION -->
  <div class="card full" style="margin-bottom:12px">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
      <div>
        <label>Freitext Suche</label>
        <input type="text" id="textFilter" placeholder="Suche Timestamp / Alter / Geschlecht…">
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- COMBINATIONS -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Kombinationen</div>
          <strong style="font-size:16px">Alter × Geschlecht × Migrationshintergrund</strong>
        </div>
        <div class="small" id="summaryCount">— Einträge</div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table class="comb-list" id="combTable">
          <thead>
            <tr>
              <th>Alter</th>
              <th>Geschlecht</th>
              <th>Migration</th>
              <th style="width:90px">Anzahl</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RAW DATA -->
    <div class="card">
      <div class="small">Rohdaten</div>
      <strong style="font-size:16px">Einträge</strong>

      <div class="table-wrap">
        <table id="rawTable">
          <thead>
            <tr><th>Timestamp</th><th>Alter</th><th>Migration</th><th>Geschlecht</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer style="margin-top:12px;text-align:right;color:var(--muted);font-size:13px">
    Datenquelle: Google Sheets
  </footer>

</div>

<script>
// CSV URL
const CSV_URL =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaFKAQwcvl7c7dT1HI_aj7THVW9DKYLGXPtvn_WR7uYEAzxyUjH3DVmTFxZefhWF5FcXoHnK-XJim5/pub?gid=1664273841&single=true&output=csv';

// DOM
const combTbody = document.querySelector('#combTable tbody');
const rawTbody = document.querySelector('#rawTable tbody');
const textFilter = document.getElementById('textFilter');
const refreshBtn = document.getElementById('refreshBtn');
const downloadBtn = document.getElementById('downloadBtn');
const summaryCountEl = document.getElementById('summaryCount');

// STATE
let headerRow = [];
let allRows = [];
let txt = "";

// CSV PARSER
function parseCSV(text){
  const rows=[]; let cur=''; let row=[]; let q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1]||'';
    if(q){
      if(c==='"'&&n==='"'){cur+='"';i++;continue;}
      if(c==='"'){q=false;continue;}
      cur+=c; continue;
    }
    if(c==='"'){q=true;continue;}
    if(c===','){row.push(cur);cur='';continue;}
    if(c==='\n'||(c==='\r'&&n==='\n')){
      row.push(cur);rows.push(row);row=[];cur='';
      if(c==='\r') i++;
      continue;
    }
    cur+=c;
  }
  if(cur!==''||row.length){row.push(cur);rows.push(row);}
  return rows;
}

function findIdx(headers, names){
  const low=headers.map(h=>h.toLowerCase().trim());
  for(const n of names){
    const i=low.indexOf(n); if(i!=-1) return i;
  }
  // fuzzy
  for(const n of names){
    for(let i=0;i<low.length;i++){
      if(low[i].includes(n)) return i;
    }
  }
  return -1;
}

function escapeHTML(s){
  return (s||"").toString().replace(/[&<>"']/g,c=>(
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
  ));
}

// FILTER
function applyFilters(rows,idx){
  return rows.filter(r=>{
    const ts=r[idx.ts]||"";
    const a=r[idx.age]||"";
    const m=r[idx.mig]||"";
    const g=r[idx.gen]||"";

    if(txt){
      const hay=(ts+" "+a+" "+m+" "+g).toLowerCase();
      if(!hay.includes(txt)) return false;
    }
    return true;
  });
}

// RENDER
function render(rows,idx){
  // COMBINATIONS
  const count={};
  rows.forEach(r=>{
    const key=[r[idx.age],r[idx.gen],r[idx.mig]].join("|");
    count[key]=(count[key]||0)+1;
  });

  const combos=Object.keys(count).map(k=>{
    const [a,g,m]=k.split("|");
    return {a,g,m,count:count[k]};
  }).sort((x,y)=>y.count-x.count);

  combTbody.innerHTML="";
  combos.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(c.a)}</td>
      <td>${escapeHTML(c.g)}</td>
      <td>${escapeHTML(c.m)}</td>
      <td style="text-align:right">${c.count}</td>`;
    combTbody.appendChild(tr);
  });
  summaryCountEl.textContent = rows.length+" Einträge";

  // RAW DATA (newest first)
  rawTbody.innerHTML="";
  rows.slice().reverse().forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(r[idx.ts])}</td>
      <td>${escapeHTML(r[idx.age])}</td>
      <td>${escapeHTML(r[idx.mig])}</td>
      <td>${escapeHTML(r[idx.gen])}</td>`;
    rawTbody.appendChild(tr);
  });
}

// FETCH + UPDATE
async function fetchAndUpdate(){
  try{
    refreshBtn.disabled=true; refreshBtn.textContent="Lade…";

    const res=await fetch(CSV_URL,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);

    const txtRaw=await res.text();
    const csv=parseCSV(txtRaw);

    headerRow=csv[0].map(h=>h.trim());
    allRows=csv.slice(1).filter(r=>r.some(c=>String(c).trim()!==""));

    const idx={
      ts:findIdx(headerRow,["timestamp","zeit","date","time"]),
      age:findIdx(headerRow,["alter","age"]),
      mig:findIdx(headerRow,["migration","migrationshintergrund"]),
      gen:findIdx(headerRow,["geschlecht","gender","sex"])
    };

    const filtered = applyFilters(allRows,idx);
    render(filtered,idx);

  }catch(e){
    alert("Fehler: "+e.message);
  }finally{
    refreshBtn.disabled=false;
    refreshBtn.textContent="Neu laden";
  }
}

// CSV EXPORT
downloadBtn.addEventListener("click",()=>{
  const idx={
    ts:findIdx(headerRow,["timestamp","zeit","date","time"]),
    age:findIdx(headerRow,["alter","age"]),
    mig:findIdx(headerRow,["migration","migrationshintergrund"]),
    gen:findIdx(headerRow,["geschlecht","gender","sex"])
  };

  const filtered=applyFilters(allRows,idx);
  const lines=[["Timestamp","Alter","Migration","Geschlecht"]];

  filtered.forEach(r=>{
    lines.push([r[idx.ts],r[idx.age],r[idx.mig],r[idx.gen]]);
  });

  const csv=lines.map(row =>
    row.map(v=>{
      const s=String(v||"");
      return (s.includes(",")||s.includes('"')) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")
  ).join("\n");

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="filtered.csv";
  document.body.appendChild(a);
  a.click();

  setTimeout(()=>{
    URL.revokeObjectURL(url);
    a.remove();
  },2000);
});

// TEXT FILTER EVENT
textFilter.addEventListener("input",()=>{
  txt = textFilter.value.toLowerCase().trim();

  const idx={
    ts:findIdx(headerRow,["timestamp","zeit","date","time"]),
    age:findIdx(headerRow,["alter","age"]),
    mig:findIdx(headerRow,["migration","migrationshintergrund"]),
    gen:findIdx(headerRow,["geschlecht","gender","sex"])
  };

  const filtered=applyFilters(allRows,idx);
  render(filtered,idx);
});

// INITIAL LOAD
fetchAndUpdate();
</script>

</body>
</html>
