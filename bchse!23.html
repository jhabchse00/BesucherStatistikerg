<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard — Büchsenstadel (Kombinationen)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #f8faff;
    --card: #ffffff;
    --muted: #6b7280;
    --text: #1f2937;
    --accent: #4f46e5;
    --accent-hover: #4338ca;
    --danger: #ef4444;
    --border: #e5e7eb;
    --table-head: #f9fafb;
  }
  * { box-sizing: border-box; }
  body {
    font-family: 'Inter', system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .wrap {
    max-width: 1300px;
    margin: 0 auto;
    padding: 24px;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 16px;
  }
  h1 { font-size: 24px; margin: 0; font-weight: 600; }
  .header-meta {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
  }
  .controls { display: flex; gap: 12px; align-items: center; }
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 20px 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.03);
    border: 1px solid var(--border);
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }
  .big { grid-column: span 2; }
  .stat { font-size: 32px; font-weight: 700; margin-top: 8px; }
  .label { color: var(--muted); font-size: 14px; font-weight: 500; }
  .muted { color: var(--muted); font-size: 13px; }
  .section-title { font-weight: 600; font-size: 18px; margin-bottom: 12px; }
  .comb-table, .sheet-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .comb-table th, .comb-table td, .sheet-table th, .sheet-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }
  .comb-table thead, .sheet-table thead {
    background: var(--table-head);
  }
  .comb-table th, .sheet-table th {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .comb-table tbody tr:nth-child(even), .sheet-table tbody tr:nth-child(even) {
    background: #fcfdff;
  }
  .comb-table tbody tr:hover, .sheet-table tbody tr:hover {
    background: #f5f8ff;
  }
  .scroll-wrap {
    max-height: 420px;
    overflow: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  .comb-scroll { max-height: 380px; }
  .row-small { font-size: 13px; color: var(--muted); }
  .top-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 12px 16px;
  }
  .btn {
    background: var(--accent);
    color: #fff;
    padding: 9px 15px;
    border-radius: 8px;
    border: 0;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .btn:hover { background: var(--accent-hover); box-shadow: 0 2px 4px rgba(0,0,0,0.07); }
  .btn.ghost {
    background: #fff;
    color: var(--accent);
    border: 1px solid var(--accent);
  }
  .btn.ghost:hover { background: #f8faff; }
  select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    font-size: 14px;
  }
  /* Scrollbar */
  .scroll-wrap::-webkit-scrollbar { width: 6px; }
  .scroll-wrap::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
  .scroll-wrap::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
  .scroll-wrap::-webkit-scrollbar-thumb:hover { background: #aaa; }

  /* Login Styles */
  #password-overlay {
    position: fixed;
    inset: 0;
    background: rgba(248, 250, 255, 0.9);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  #password-prompt {
    width: 100%;
    max-width: 360px;
    text-align: center;
  }
  #passInput {
    width: 100%;
    padding: 12px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-size: 16px;
    margin-top: 16px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  #passInput:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    outline: none;
  }
  #loginBtn {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    font-size: 16px;
  }

  @media (max-width: 960px) {
    .grid { grid-template-columns: repeat(1, 1fr); }
    .big { grid-column: span 1; }
    header { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>

  <div id="password-overlay">
    <div id="password-prompt" class="card">
      <h2 style="margin-top:0; font-weight: 600;">Admin Dashboard</h2>
      <p class="muted" style="font-size: 15px;">Bitte Passwort eingeben:</p>
      <input type="password" id="passInput" placeholder="Passwort">
      <button id="loginBtn" class="btn">Anmelden</button>
      <p id="errorMsg" style="color:var(--danger); font-size: 14px; display: none; margin-top: 12px; margin-bottom: 0;">Falsches Passwort.</p>
    </div>
  </div>

  <div id="dashboard-content" class="wrap" style="display:none;">
    <header>
      <div>
        <h1>Büchsenstadel Dashboard</h1>
        <div class="header-meta">Datenquelle: Google Sheets (published CSV)</div>
      </div>

      <div class="controls">
        <div class="top-controls card">
          <button id="refreshBtn" class="btn ghost" title="Manuell neu laden">Neu laden</button>
          <button id="downloadBtn" class="btn" title="CSV herunterladen">CSV herunterladen</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="label">Gesamt</div>
        <div id="total" class="stat">—</div>
        <div class="row-small" id="lastUpdate" style="margin-top: 8px;">—</div>
      </div>

      <div class="card">
        <div class="label">Schnellstatistiken</div>
        <div style="display:flex; gap: 24px; margin-top:8px">
          <div>
            <div class="stat" id="maleCount">—</div>
            <div class="label">Männlich</div>
          </div>
          <div>
            <div class="stat" id="femaleCount">—</div>
            <div class="label">Weiblich</div>
          </div>
          <div>
            <div class="stat" id="otherCount">—</div>
            <div class="label">Divers/Unbek.</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="label">Daten-Status</div>
        <div class="muted" id="fetchStatus" style="font-size: 14px; font-weight: 500; margin-top: 8px;">Warte auf Laden…</div>
        <div style="margin-top:10px" class="row-small">Hinweis: Die Kombinationstabelle listet nur Gruppen mit min. 1 Eintrag.</div>
      </div>

      <div class="card big">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div class="section-title" style="margin-bottom: 0;">Kombinationen (Alter × Geschlecht × Migration)</div>
          <div style="display:flex; gap: 8px; align-items: center">
            <div class="muted">Sortieren:</div>
            <select id="sortComb">
              <option value="count_desc">Anzahl (absteigend)</option>
              <option value="count_asc">Anzahl (aufsteigend)</option>
              <option value="label_asc">Label A→Z</option>
            </select>
          </div>
        </div>

        <div class="scroll-wrap comb-scroll">
          <table class="comb-table" id="combTable">
            <thead>
              <tr><th>Alter</th><th>Geschlecht</th><th>Migrationshintergrund</th><th>Anzahl</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Rohdaten (Letzte 500)</div>
        <div class="scroll-wrap" id="sheetWrap" style="margin-top:8px">
          <table class="sheet-table" id="sheetTable">
            <thead><tr><th>Timestamp</th><th>Alter</th><th>Migration</th><th>Geschlecht</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer style="text-align:center; margin-top:10px; color:var(--muted); font-size: 13px;">
      Admin Panel · Letzte Aktualisierung: <span id="updatedAt">—</span>
    </footer>
  </div>

<script>
/* ====== CONFIG: replace this with your published CSV URL ====== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaFKAQwcvl7c7dT1HI_aj7THVW9DKYLGXPtvn_WR7uYEAzxyUjH3DVmTFxZefhWF5FcXoHnK-XJim5/pub?gid=1664273841&single=true&output=csv';

/* ====== CSV parser (robust for quoted fields) ====== */
function parseCSV(text){
  const rows = [];
  let i = 0, cur = '', row = [], inQuotes = false;
  while(i < text.length){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { cur += ch; i++; continue; }
    }
    if(ch === '"'){ inQuotes = true; i++; continue; }
    if(ch === ','){ row.push(cur); cur=''; i++; continue; }
    if(ch === '\r'){ i++; continue; }
    if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
    cur += ch; i++;
  }
  if(cur !== '' || inQuotes || row.length) row.push(cur);
  if(row.length) rows.push(row);
  return rows;
}

/* ====== fuzzy header detection ====== */
function detectIndexes(headers){
  const low = headers.map(h => (h||'').toString().toLowerCase().trim());
  function findAny(cands){
    for(const c of cands){
      const idx = low.findIndex(h => h === c.toLowerCase());
      if(idx !== -1) return idx;
    }
    for(const c of cands){
      const idx = low.findIndex(h => h.includes(c.toLowerCase()));
      if(idx !== -1) return idx;
    }
    return -1;
  }
  return {
    idxTimestamp: findAny(['timestamp','zeit','date','time','zeitstempel']),
    idxAge: findAny(['alter','age']),
    idxMig: findAny(['migrationshintergrund','migration','migrant','migration background','migrations'] ),
    idxGender: findAny(['geschlecht','gender','sex'])
  };
}

/* ====== normalization helpers ====== */
function normGender(g){
  if(!g) return 'Unbekannt';
  const s = g.toString().trim().toLowerCase();
  if(s.startsWith('männ') || s === 'm' || s.startsWith('male')) return 'Männlich';
  if(s.startsWith('w') || s === 'f' || s.startsWith('weib')) return 'Weiblich';
  if(s.startsWith('d') || s.includes('div')) return 'Divers';
  if (s.length === 0) return 'Unbekannt';
  return 'Divers'; // Catch-all for other entries
}

/**
 * [BUG FIX] This function was rewritten to correctly handle ranges and ambiguous numbers.
 * The old logic miscategorized strings like '18-27' as '14-18'.
 */
function normAge(a){
  if(!a) return 'Unbekannt';
  const s = a.toString().trim();

  // 1. Check for '27+' variants (most specific)
  if(s.includes('27+') || s.includes('über') || /\b(2[8-9]|[3-9]\d)\b/.test(s)) return '27+';
  
  // 2. Check for '18-27' variants
  if(s.includes('18-27') || s.includes('18–27') || /\b(19|20|21|22|23|24|25|26|27)\b/.test(s)) return '18–27';
  
  // 3. Check for '14-18' variants
  if(s.includes('14-18') || s.includes('14–18') || /\b(14|15|16|17|18)\b/.test(s)) return '14–18';
  
  // 4. Check for '10-14' variants
  if(s.includes('10-14') || s.includes('10–14') || /\b(10|11|12|13)\b/.test(s)) return '10–14';

  // 5. Handle remaining edge cases or unbucketed values
  if(s.length > 0) return s; // Return as-is if not bucketed (e.g., "9")
  return 'Unbekannt';
}

function normMig(m){
  if(!m) return 'Unbekannt';
  const s = m.toString().trim().toLowerCase();
  if(s.startsWith('j') || s.includes('yes') || s === 'ja') return 'Ja';
  if(s.startsWith('n') || s.includes('no') || s === 'nein') return 'Nein';
  if (s.length === 0) return 'Unbekannt';
  return 'Unbekannt'; // Default for other values
}

/* ====== UI refs ====== */
const totalEl = document.getElementById('total');
const lastUpdateEl = document.getElementById('lastUpdate');
const fetchStatusEl = document.getElementById('fetchStatus');
const updatedAtEl = document.getElementById('updatedAt');
const sheetTbody = document.querySelector('#sheetTable tbody');
const combTbody = document.querySelector('#combTable tbody');
const maleCountEl = document.getElementById('maleCount');
const femaleCountEl = document.getElementById('femaleCount');
const otherCountEl = document.getElementById('otherCount');
const refreshBtn = document.getElementById('refreshBtn');
const downloadBtn = document.getElementById('downloadBtn');
const sortSelect = document.getElementById('sortComb');

let allRows = [];
let headerRow = [];

/* ====== fetch & process ====== */
async function fetchAndRender(){
  try{
    fetchStatusEl.innerText = 'Lade…';
    lastUpdateEl.innerText = 'Lade…';
    const t0 = Date.now();
    const res = await fetch(CSV_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if(rows.length < 1) throw new Error('Keine Daten in CSV');
    headerRow = rows[0];
    allRows = rows.slice(1).filter(r => r.some(c => c && c.toString().trim() !== ''));

    const idx = detectIndexes(headerRow);
    if(idx.idxAge === -1 || idx.idxGender === -1 || idx.idxMig === -1 || idx.idxTimestamp === -1){
      fetchStatusEl.innerText = 'Fehler: Header nicht gefunden. Erwartet: Timestamp, Alter, Migrationshintergrund, Geschlecht (fuzzy)';
      console.error('Detected headers:', headerRow);
      return;
    }

    // Filters removed, use allRows directly
    renderSheetTable(allRows, idx);
    renderCombos(allRows, idx);

    const took = ((Date.now()-t0)/1000).toFixed(2);
    fetchStatusEl.innerText = `OK (${took}s)`;
    const nowStr = new Date().toLocaleString('de-DE', { timeStyle: 'medium', dateStyle: 'short' });
    lastUpdateEl.innerText = `Letztes Laden: ${nowStr}`;
    updatedAtEl.innerText = nowStr;
  }catch(e){
    console.error(e);
    fetchStatusEl.innerText = 'Fehler: ' + (e.message || e);
    lastUpdateEl.innerText = 'Fehler beim Laden';
  }
}

/* ====== Render raw sheet table ====== */
function renderSheetTable(rows, idx){
  sheetTbody.innerHTML = '';
  const show = rows.slice(-500); // Show last 500
  for(let i=show.length-1;i>=0;i--){ // Iterate backwards to show newest first
    const r = show[i];
    const tr = document.createElement('tr');
    const ts = r[idx.idxTimestamp] || '';
    const age = r[idx.idxAge] || '';
    const mig = r[idx.idxMig] || '';
    const gen = r[idx.idxGender] || '';
    
    let tsFormatted = ts;
    try {
      tsFormatted = new Date(ts).toLocaleString('de-DE', { timeStyle: 'short', dateStyle: 'short' });
    } catch(e) {}
    
    tr.innerHTML = `<td class="row-small">${escapeHtml(tsFormatted)}</td>
                    <td>${escapeHtml(age)}</td>
                    <td>${escapeHtml(mig)}</td>
                    <td>${escapeHtml(gen)}</td>`;
    sheetTbody.appendChild(tr);
  }
}

/* ====== Render combos (only existing combos) ====== */
function renderCombos(rows, idx){
  const counts = {};
  const genderTotals = {Männlich:0,Weiblich:0,Divers:0};
  
  rows.forEach(r => {
    const rawAge = r[idx.idxAge] || '';
    const rawGender = r[idx.idxGender] || '';
    const rawMig = r[idx.idxMig] || '';

    const age = normAge(rawAge);
    const gen = normGender(rawGender);
    const mig = normMig(rawMig);

    if(gen === 'Männlich') genderTotals.Männlich++;
    else if(gen === 'Weiblich') genderTotals.Weiblich++;
    else genderTotals.Divers++;

    const key = age + '|' + gen + '|' + mig;
    counts[key] = (counts[key] || 0) + 1;
  });

  // build rows only for keys that exist
  const rowsOut = Object.keys(counts).map(k => {
    const [age, gen, mig] = k.split('|');
    return {age, gen, mig, count: counts[k]};
  });

  const sortMode = sortSelect.value;
  if(sortMode === 'count_desc') rowsOut.sort((a,b)=>b.count-a.count);
  else if(sortMode === 'count_asc') rowsOut.sort((a,b)=>a.count-b.count);
  else rowsOut.sort((a,b)=> (a.age + a.gen + a.mig).localeCompare(b.age + b.gen + b.mig));

  combTbody.innerHTML = '';
  rowsOut.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.age)}</td>
                    <td>${escapeHtml(r.gen)}</td>
                    <td>${escapeHtml(r.mig)}</td>
                    <td style="font-weight:700; font-size: 15px;">${r.count}</td>`;
    combTbody.appendChild(tr);
  });

  totalEl.innerText = rows.length;
  maleCountEl.innerText = genderTotals.Männlich;
  femaleCountEl.innerText = genderTotals.Weiblich;
  otherCountEl.innerText = genderTotals.Divers;
}

/* ====== download current filtered CSV ====== */
function downloadCSV(){
  const header = ['Timestamp','Alter','Migrationshintergrund','Geschlecht'];
  const idx = detectIndexes(headerRow);
  // No filter, use allRows
  const lines = [header.join(',')];
  allRows.forEach(r=>{
    const cells = [quoteCSV(r[idx.idxTimestamp]||''), quoteCSV(r[idx.idxAge]||''), quoteCSV(r[idx.idxMig]||''), quoteCSV(r[idx.idxGender]||'')];
    lines.push(cells.join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'submissions_export.csv'; document.body.appendChild(a); a.click();
S  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 5000);
}

/* ====== helpers ====== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function quoteCSV(s){ const t = (s||'').toString(); if(t.includes(',')||t.includes('"')||t.includes('\n')) return `"${t.replace(/"/g,'""')}"`; return t; }

/* ====== events ====== */
refreshBtn.addEventListener('click', ()=> fetchAndRender());
downloadBtn.addEventListener('click', downloadCSV);
sortSelect.addEventListener('change', ()=> renderCombos(allRows, detectIndexes(headerRow)));

/* ====== Password Protection Logic ====== */
const loginOverlay = document.getElementById('password-overlay');
const dashboardContent = document.getElementById('dashboard-content');
const loginBtn = document.getElementById('loginBtn');
const passInput = document.getElementById('passInput');
const errorMsg = document.getElementById('errorMsg');

function initDashboard() {
  // This code runs after a successful login
  fetchAndRender();
}

function checkPassword() {
  if (passInput.value === '89073') {
    loginOverlay.style.display = 'none';
    dashboardContent.style.display = 'block';
    errorMsg.style.display = 'none';
    
    // Now run the dashboard initialization
    initDashboard();
  } else {
    errorMsg.style.display = 'block';
    passInput.value = '';
    // Add a small shake animation for bad password
    const prompt = document.getElementById('password-prompt');
    prompt.style.animation = 'shake 0.3s';
    setTimeout(() => prompt.style.animation = '', 300);
  }
}
// Add a keyframe for the shake
const styleEl = document.createElement('style');
styleEl.innerHTML = `@keyframes shake {
  10%, 90% { transform: translateX(-1px); }
  20%, 80% { transform: translateX(2px); }
  30%, 50%, 70% { transform: translateX(-4px); }
  40%, 60% { transform: translateX(4px); }
}`;
document.head.appendChild(styleEl);


loginBtn.addEventListener('click', checkPassword);
passInput.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') checkPassword();
});

// Focus the password input on load
passInput.focus();

</script>
</body>
</html>
